meta:
  id: crm
  version: 0.1.0
  owner: Sales Team

glossary:
  - id: account
    name: Account
    definition: "An organization or customer entity with whom we have or seek a commercial relationship."
  - id: contact
    name: Contact
    definition: "A person associated with an Account."
  - id: lead
    name: Lead
    definition: "A prospect not yet qualified to an Account or Opportunity."
  - id: opportunity
    name: Opportunity
    definition: "A potential sale with scope, value, and probability."
  - id: quote
    name: Quote
    definition: "A formal commercial proposal based on Opportunity scope."
  - id: contract
    name: Contract
    definition: "A legally binding agreement granting rights and obligations."
  - id: consent
    name: Consent
    definition: "Grant of permission to process personal data or contact a person under policy/regulation."
  - id: product_offering
    name: ProductOffering
    definition: "A sellable package with commercial terms."
  - id: territory
    name: Territory
    definition: "A sales coverage area with assignment rules."

lifecycles:
  lead:
    states: ["new", "working", "qualified", "disqualified", "converted"]
    transitions:
      - "new -> working"
      - "working -> qualified"
      - "working -> disqualified"
      - "qualified -> converted"
    notes: "Conversion creates or links an Account and optionally an Opportunity."
  opportunity:
    states: ["open", "negotiation", "won", "lost", "closed"]
    transitions:
      - "open -> negotiation"
      - "negotiation -> won"
      - "negotiation -> lost"
      - "won -> closed"
      - "lost -> closed"
  quote:
    states: ["draft", "issued", "accepted", "expired", "withdrawn"]
    transitions:
      - "draft -> issued"
      - "issued -> accepted"
      - "issued -> expired"
      - "issued -> withdrawn"
  contract:
    states: ["draft", "active", "suspended", "terminated", "expired"]
    transitions:
      - "draft -> active"
      - "active -> suspended"
      - "active -> terminated"
      - "active -> expired"
  consent:
    states: ["granted", "revoked"]
    transitions:
      - "granted -> revoked"

invariants:
  - id: opp_has_single_account
    rule: "Every Opportunity is associated to exactly one Account."
  - id: quote_aligns_with_opp
    rule: "An Accepted Quote must reference exactly one Opportunity and its scope is a subset of that Opportunity's scope at acceptance."
  - id: contract_after_won
    rule: "A Contract may become Active only if derived from a Won Opportunity and an Accepted Quote."
  - id: one_active_contract_per_account_offering
    rule: "At most one Active Contract exists per Account × ProductOffering × effective period unless exclusivity is explicitly waived."
  - id: consent_gates_communication
    rule: "Outbound communication to a Contact requires Consent Granted for the relevant channel and purpose."
  - id: territory_assignment_stability
    rule: "Opportunity territory may change only at stage boundaries (Open↔Negotiation); changes are disallowed after Won/Lost."

events:
  - id: lead_qualified
    name: LeadQualified
    definition: "LeadQualified(subject: Lead, occurred: Time)"
  - id: lead_converted
    name: LeadConverted
    definition: "LeadConverted(subject: Lead, occurred: Time)"
  - id: opportunity_stage_advanced
    name: OpportunityStageAdvanced
    definition: "OpportunityStageAdvanced(subject: Opportunity, occurred: Time)"
  - id: quote_issued
    name: QuoteIssued
    definition: "QuoteIssued(subject: Quote, occurred: Time)"
  - id: quote_accepted
    name: QuoteAccepted
    definition: "QuoteAccepted(subject: Quote, occurred: Time)"
  - id: contract_activated
    name: ContractActivated
    definition: "ContractActivated(subject: Contract, occurred: Time)"
  - id: consent_granted
    name: ConsentGranted
    definition: "ConsentGranted(subject: Consent, occurred: Time)"
  - id: consent_revoked
    name: ConsentRevoked
    definition: "ConsentRevoked(subject: Consent, occurred: Time)"