meta:
  id: design.catalog.publish-product
  name: Publish Product Design
  owner: Catalog Team
  description: "Level-1 design for publishing products with collision-free identifiers"

extends: feature.catalog.publish-product

invariant_mechanisms:
  - invariant_ref: unique-model-code-per-brand
    mechanism: partitioned-unique-index
    notes: "Enforced via unique index on (brand_id, model_code) where status = 'active'"
  - invariant_ref: variant-sku-unique-per-product
    mechanism: db-constraint
    notes: "Enforced via unique constraint on (product_id, sku)"

consistency_groups:
  - id: product
    name: Product
  - id: variant
    name: Variant
commands:
  - id: activate-product
    name: ActivateProduct
    target: product
    intent: 'Publish product under a Brand'
    preconditions: ['unique-model-code-per-brand']
    postconditions:
      state_transitions:
        - entity: product
          from: draft
          to: active
      emits:
        - event: product-activated
    transactional_expectation: 'starts-saga'
    failure_modes:
      - violates: 'unique-model-code-per-brand'
        outcome:
          action: reject
          error_code: '409'
          message: 'Duplicate model code for this brand'

  - id: activate-variant
    name: ActivateVariant
    target: variant
    intent: 'Publish purchasable SKU'
    preconditions: ['variant-sku-unique-per-product']
    postconditions:
      emits:
        - event: variant-activated
    failure_modes:
      - violates: 'variant-sku-unique-per-product'
        outcome:
          action: reject
          error_code: '409'
          message: 'Duplicate SKU for this product'

queries:
  - id: get-product
    name: GetProduct
    intent: 'Show product details on PDP'
    parameters:
      - name: productId
        type: string
    returns:
      type: ProductDetails
      description: 'Rich product data including all active variants'

  - id: list-products-by-brand
    name: ListProductsByBrand
    intent: 'Show brand landing page'
    parameters:
      - name: brandId
        type: string
    returns:
      type: List<ProductSummary>
      description: 'Paginated list of active products for the brand'