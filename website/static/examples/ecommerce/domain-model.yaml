meta:
  id: ecommerce
  owner: Commerce Team

glossary:
  - id: customer
    name: Customer
    definition: "A buyer with an identity recognized by the store."
  - id: product
    name: Product
    definition: "A sellable item with catalog identity and pricing policies."
  - id: order
    name: Order
    definition: "A commitment to purchase specific products and quantities at agreed prices."
  - id: order-line
    name: OrderLine
    definition: "A specific product and quantity within an Order at a priced snapshot."
  - id: inventory-reservation
    name: InventoryReservation
    definition: "A temporary claim on stock for an Order or Shipment."
  - id: payment-intent
    name: PaymentIntent
    definition: "A customer payment authorization/capture intent for an Order."
  - id: shipment
    name: Shipment
    definition: "A fulfillment of one or more OrderLines to a delivery destination."
  - id: return
    name: Return
    definition: "A customer-initiated return of delivered merchandise."
  - id: promotion
    name: Promotion
    definition: "A policy that can reduce price under eligibility rules."

lifecycles:
  order:
    states: 
      - id: draft
        name: Draft
      - id: submitted
        name: Submitted
      - id: confirmed
        name: Confirmed
      - id: partially-fulfilled
        name: PartiallyFulfilled
      - id: fulfilled
        name: Fulfilled
      - id: cancelled
        name: Cancelled
    transitions:
      - "draft -> submitted"
      - "submitted -> confirmed"
      - "confirmed -> partially-fulfilled"
      - "partially-fulfilled -> fulfilled"
      - "submitted -> cancelled"
      - "confirmed -> cancelled"
    notes: "Cancellation after any fulfillment requires reverse logistics and financial adjustments."
  payment-intent:
    states: 
      - id: created
        name: Created
      - id: authorized
        name: Authorized
      - id: captured
        name: Captured
      - id: voided
        name: Voided
      - id: refunded
        name: Refunded
    transitions:
      - "created -> authorized"
      - "authorized -> captured"
      - "authorized -> voided"
      - "captured -> refunded"
  inventory-reservation:
    states: 
      - id: reserved
        name: Reserved
      - id: consumed
        name: Consumed
      - id: released
        name: Released
      - id: expired
        name: Expired
    transitions:
      - "reserved -> consumed"
      - "reserved -> released"
      - "reserved -> expired"
  shipment:
    states: 
      - id: ready
        name: Ready
      - id: in-transit
        name: InTransit
      - id: delivered
        name: Delivered
      - id: lost
        name: Lost
    transitions:
      - "ready -> in-transit"
      - "in_transit -> delivered"
      - "in_transit -> lost"
  return:
    states: 
      - id: requested
        name: Requested
      - id: approved
        name: Approved
      - id: received
        name: Received
      - id: refunded
        name: Refunded
      - id: rejected
        name: Rejected
    transitions:
      - "requested -> approved"
      - "approved -> received"
      - "received -> refunded"
      - "requested -> rejected"

invariants:
  - id: price-snapshot-at-submit
    rule: "An Order's monetary commitments equal the sum of its OrderLines priced at the moment of submission, including promotions applicable at that moment."
  - id: reservation-before-confirm
    rule: "Sufficient InventoryReservation must exist for all OrderLines before an Order transitions to Confirmed."
  - id: capture-not-exceed-authorize
    rule: "Captured payment cannot exceed the last valid Authorized amount for the PaymentIntent."
  - id: ship-only-confirmed-lines
    rule: "Shipment may only include OrderLines belonging to a Confirmed (or later) Order state."
  - id: one-return-per-unit
    rule: "A delivered unit may be returned at most once."
  - id: return-window-policy
    rule: "Return can be Approved only if requested within the applicable return window for the Product."
  - id: refund-after-receipt-or-proof
    rule: "A Refund can be executed only after Returned goods are Received or acceptable proof-of-non-delivery exists."

events:
  - id: order-submitted
    name: OrderSubmitted
    definition: "OrderSubmitted(subject: Order, occurred: Time)"
  - id: inventory-reserved
    name: InventoryReserved
    definition: "InventoryReserved(subject: InventoryReservation, occurred: Time)"
  - id: order-confirmed
    name: OrderConfirmed
    definition: "OrderConfirmed(subject: Order, occurred: Time)"
  - id: payment-authorized
    name: PaymentAuthorized
    definition: "PaymentAuthorized(subject: PaymentIntent, occurred: Time)"
  - id: payment-captured
    name: PaymentCaptured
    definition: "PaymentCaptured(subject: PaymentIntent, occurred: Time)"
  - id: shipment-delivered
    name: ShipmentDelivered
    definition: "ShipmentDelivered(subject: Shipment, occurred: Time)"
  - id: return-requested
    name: ReturnRequested
    definition: "ReturnRequested(subject: Return, occurred: Time)"
  - id: refund-issued
    name: RefundIssued
    definition: "RefundIssued(subject: PaymentIntent, occurred: Time)"