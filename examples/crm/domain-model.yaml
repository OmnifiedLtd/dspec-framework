meta:
  id: crm
  version: 0.1.0
  owner: Sales Team

glossary:
  - id: Account
    name: Account
    definition: "An organization or customer entity with whom we have or seek a commercial relationship."
  - id: Contact
    name: Contact
    definition: "A person associated with an Account."
  - id: Lead
    name: Lead
    definition: "A prospect not yet qualified to an Account or Opportunity."
  - id: Opportunity
    name: Opportunity
    definition: "A potential sale with scope, value, and probability."
  - id: Quote
    name: Quote
    definition: "A formal commercial proposal based on Opportunity scope."
  - id: Contract
    name: Contract
    definition: "A legally binding agreement granting rights and obligations."
  - id: Consent
    name: Consent
    definition: "Grant of permission to process personal data or contact a person under policy/regulation."
  - id: ProductOffering
    name: ProductOffering
    definition: "A sellable package with commercial terms."
  - id: Territory
    name: Territory
    definition: "A sales coverage area with assignment rules."

lifecycles:
  Lead:
    states: ["New", "Working", "Qualified", "Disqualified", "Converted"]
    transitions:
      - "New -> Working"
      - "Working -> Qualified"
      - "Working -> Disqualified"
      - "Qualified -> Converted"
    notes: "Conversion creates or links an Account and optionally an Opportunity."
  Opportunity:
    states: ["Open", "Negotiation", "Won", "Lost", "Closed"]
    transitions:
      - "Open -> Negotiation"
      - "Negotiation -> Won"
      - "Negotiation -> Lost"
      - "Won -> Closed"
      - "Lost -> Closed"
  Quote:
    states: ["Draft", "Issued", "Accepted", "Expired", "Withdrawn"]
    transitions:
      - "Draft -> Issued"
      - "Issued -> Accepted"
      - "Issued -> Expired"
      - "Issued -> Withdrawn"
  Contract:
    states: ["Draft", "Active", "Suspended", "Terminated", "Expired"]
    transitions:
      - "Draft -> Active"
      - "Active -> Suspended"
      - "Active -> Terminated"
      - "Active -> Expired"
  Consent:
    states: ["Granted", "Revoked"]
    transitions:
      - "Granted -> Revoked"

invariants:
  - id: opp-has-single-account
    rule: "Every Opportunity is associated to exactly one Account."
  - id: quote-aligns-with-opp
    rule: "An Accepted Quote must reference exactly one Opportunity and its scope is a subset of that Opportunity's scope at acceptance."
  - id: contract-after-won
    rule: "A Contract may become Active only if derived from a Won Opportunity and an Accepted Quote."
  - id: one-active-contract-per-account-offering
    rule: "At most one Active Contract exists per Account × ProductOffering × effective period unless exclusivity is explicitly waived."
  - id: consent-gates-communication
    rule: "Outbound communication to a Contact requires Consent Granted for the relevant channel and purpose."
  - id: territory-assignment-stability
    rule: "Opportunity territory may change only at stage boundaries (Open↔Negotiation); changes are disallowed after Won/Lost."

events:
  - id: LeadQualified
    name: LeadQualified
    definition: "LeadQualified(subject: Lead, occurred: Time)"
  - id: LeadConverted
    name: LeadConverted
    definition: "LeadConverted(subject: Lead, occurred: Time)"
  - id: OpportunityStageAdvanced
    name: OpportunityStageAdvanced
    definition: "OpportunityStageAdvanced(subject: Opportunity, occurred: Time)"
  - id: QuoteIssued
    name: QuoteIssued
    definition: "QuoteIssued(subject: Quote, occurred: Time)"
  - id: QuoteAccepted
    name: QuoteAccepted
    definition: "QuoteAccepted(subject: Quote, occurred: Time)"
  - id: ContractActivated
    name: ContractActivated
    definition: "ContractActivated(subject: Contract, occurred: Time)"
  - id: ConsentGranted
    name: ConsentGranted
    definition: "ConsentGranted(subject: Consent, occurred: Time)"
  - id: ConsentRevoked
    name: ConsentRevoked
    definition: "ConsentRevoked(subject: Consent, occurred: Time)"