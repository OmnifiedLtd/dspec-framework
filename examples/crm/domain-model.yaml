meta:
  id: crm
  owner: Sales Team

glossary:
  - id: account
    name: Account
    definition: "An organization or customer entity with whom we have or seek a commercial relationship."
  - id: contact
    name: Contact
    definition: "A person associated with an Account."
  - id: lead
    name: Lead
    definition: "A prospect not yet qualified to an Account or Opportunity."
  - id: opportunity
    name: Opportunity
    definition: "A potential sale with scope, value, and probability."
  - id: quote
    name: Quote
    definition: "A formal commercial proposal based on Opportunity scope."
  - id: contract
    name: Contract
    definition: "A legally binding agreement granting rights and obligations."
  - id: consent
    name: Consent
    definition: "Grant of permission to process personal data or contact a person under policy/regulation."
  - id: product-offering
    name: ProductOffering
    definition: "A sellable package with commercial terms."
  - id: territory
    name: Territory
    definition: "A sales coverage area with assignment rules."

lifecycles:
  - id: lead
    states: 
      - id: new
        name: New
      - id: working
        name: Working
      - id: qualified
        name: Qualified
      - id: disqualified
        name: Disqualified
      - id: converted
        name: Converted
    transitions:
      - from: new
        to: working
      - from: working
        to: qualified
        trigger: lead-qualified
      - from: working
        to: disqualified
      - from: qualified
        to: converted
        trigger: lead-converted
    notes: "Conversion creates or links an Account and optionally an Opportunity."
  - id: opportunity
    states: 
      - id: open
        name: Open
      - id: negotiation
        name: Negotiation
      - id: won
        name: Won
      - id: lost
        name: Lost
      - id: closed
        name: Closed
    transitions:
      - from: open
        to: negotiation
        trigger: opportunity-stage-advanced
      - from: negotiation
        to: won
      - from: negotiation
        to: lost
      - from: won
        to: closed
      - from: lost
        to: closed
  - id: quote
    states: 
      - id: draft
        name: Draft
      - id: issued
        name: Issued
      - id: accepted
        name: Accepted
      - id: expired
        name: Expired
      - id: withdrawn
        name: Withdrawn
    transitions:
      - from: draft
        to: issued
        trigger: quote-issued
      - from: issued
        to: accepted
        trigger: quote-accepted
      - from: issued
        to: expired
      - from: issued
        to: withdrawn
  - id: contract
    states: 
      - id: draft
        name: Draft
      - id: active
        name: Active
      - id: suspended
        name: Suspended
      - id: terminated
        name: Terminated
      - id: expired
        name: Expired
    transitions:
      - from: draft
        to: active
        trigger: contract-activated
      - from: active
        to: suspended
      - from: active
        to: terminated
      - from: active
        to: expired
  - id: consent
    states: 
      - id: granted
        name: Granted
      - id: revoked
        name: Revoked
    transitions:
      - from: granted
        to: revoked
        trigger: consent-revoked

invariants:
  - id: opp-has-single-account
    rule: "Every Opportunity is associated to exactly one Account."
  - id: quote-aligns-with-opp
    rule: "An Accepted Quote must reference exactly one Opportunity and its scope is a subset of that Opportunity's scope at acceptance."
  - id: contract-after-won
    rule: "A Contract may become Active only if derived from a Won Opportunity and an Accepted Quote."
  - id: one-active-contract-per-account-offering
    rule: "At most one Active Contract exists per Account × ProductOffering × effective period unless exclusivity is explicitly waived."
  - id: consent-gates-communication
    rule: "Outbound communication to a Contact requires Consent Granted for the relevant channel and purpose."
  - id: territory-assignment-stability
    rule: "Opportunity territory may change only at stage boundaries (Open↔Negotiation); changes are disallowed after Won/Lost."

events:
  - id: lead-qualified
    name: LeadQualified
    definition: "LeadQualified(subject: Lead, occurred: Time)"
    subject_ref: lead
  - id: lead-converted
    name: LeadConverted
    definition: "LeadConverted(subject: Lead, occurred: Time)"
    subject_ref: lead
  - id: opportunity-stage-advanced
    name: OpportunityStageAdvanced
    definition: "OpportunityStageAdvanced(subject: Opportunity, occurred: Time)"
    subject_ref: opportunity
  - id: quote-issued
    name: QuoteIssued
    definition: "QuoteIssued(subject: Quote, occurred: Time)"
    subject_ref: quote
  - id: quote-accepted
    name: QuoteAccepted
    definition: "QuoteAccepted(subject: Quote, occurred: Time)"
    subject_ref: quote
  - id: contract-activated
    name: ContractActivated
    definition: "ContractActivated(subject: Contract, occurred: Time)"
    subject_ref: contract
  - id: consent-granted
    name: ConsentGranted
    definition: "ConsentGranted(subject: Consent, occurred: Time)"
    subject_ref: consent
  - id: consent-revoked
    name: ConsentRevoked
    definition: "ConsentRevoked(subject: Consent, occurred: Time)"
    subject_ref: consent
