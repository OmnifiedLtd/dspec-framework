meta:
  id: ecommerce
  version: 0.1.0
  owner: Commerce Team

glossary:
  - id: customer
    name: Customer
    definition: "A buyer with an identity recognized by the store."
  - id: product
    name: Product
    definition: "A sellable item with catalog identity and pricing policies."
  - id: order
    name: Order
    definition: "A commitment to purchase specific products and quantities at agreed prices."
  - id: order_line
    name: OrderLine
    definition: "A specific product and quantity within an Order at a priced snapshot."
  - id: inventory_reservation
    name: InventoryReservation
    definition: "A temporary claim on stock for an Order or Shipment."
  - id: payment_intent
    name: PaymentIntent
    definition: "A customer payment authorization/capture intent for an Order."
  - id: shipment
    name: Shipment
    definition: "A fulfillment of one or more OrderLines to a delivery destination."
  - id: return
    name: Return
    definition: "A customer-initiated return of delivered merchandise."
  - id: promotion
    name: Promotion
    definition: "A policy that can reduce price under eligibility rules."

lifecycles:
  order:
    states: ["draft", "submitted", "confirmed", "partially_fulfilled", "fulfilled", "cancelled"]
    transitions:
      - "draft -> submitted"
      - "submitted -> confirmed"
      - "confirmed -> partially_fulfilled"
      - "partially_fulfilled -> fulfilled"
      - "submitted -> cancelled"
      - "confirmed -> cancelled"
    notes: "Cancellation after any fulfillment requires reverse logistics and financial adjustments."
  payment_intent:
    states: ["created", "authorized", "captured", "voided", "refunded"]
    transitions:
      - "created -> authorized"
      - "authorized -> captured"
      - "authorized -> voided"
      - "captured -> refunded"
  inventory_reservation:
    states: ["reserved", "consumed", "released", "expired"]
    transitions:
      - "reserved -> consumed"
      - "reserved -> released"
      - "reserved -> expired"
  shipment:
    states: ["ready", "in_transit", "delivered", "lost"]
    transitions:
      - "ready -> in_transit"
      - "in_transit -> delivered"
      - "in_transit -> lost"
  return:
    states: ["requested", "approved", "received", "refunded", "rejected"]
    transitions:
      - "requested -> approved"
      - "approved -> received"
      - "received -> refunded"
      - "requested -> rejected"

invariants:
  - id: price_snapshot_at_submit
    rule: "An Order's monetary commitments equal the sum of its OrderLines priced at the moment of submission, including promotions applicable at that moment."
  - id: reservation_before_confirm
    rule: "Sufficient InventoryReservation must exist for all OrderLines before an Order transitions to Confirmed."
  - id: capture_not_exceed_authorize
    rule: "Captured payment cannot exceed the last valid Authorized amount for the PaymentIntent."
  - id: ship_only_confirmed_lines
    rule: "Shipment may only include OrderLines belonging to a Confirmed (or later) Order state."
  - id: one_return_per_unit
    rule: "A delivered unit may be returned at most once."
  - id: return_window_policy
    rule: "Return can be Approved only if requested within the applicable return window for the Product."
  - id: refund_after_receipt_or_proof
    rule: "A Refund can be executed only after Returned goods are Received or acceptable proof-of-non-delivery exists."

events:
  - id: order_submitted
    name: OrderSubmitted
    definition: "OrderSubmitted(subject: Order, occurred: Time)"
  - id: inventory_reserved
    name: InventoryReserved
    definition: "InventoryReserved(subject: InventoryReservation, occurred: Time)"
  - id: order_confirmed
    name: OrderConfirmed
    definition: "OrderConfirmed(subject: Order, occurred: Time)"
  - id: payment_authorized
    name: PaymentAuthorized
    definition: "PaymentAuthorized(subject: PaymentIntent, occurred: Time)"
  - id: payment_captured
    name: PaymentCaptured
    definition: "PaymentCaptured(subject: PaymentIntent, occurred: Time)"
  - id: shipment_delivered
    name: ShipmentDelivered
    definition: "ShipmentDelivered(subject: Shipment, occurred: Time)"
  - id: return_requested
    name: ReturnRequested
    definition: "ReturnRequested(subject: Return, occurred: Time)"
  - id: refund_issued
    name: RefundIssued
    definition: "RefundIssued(subject: PaymentIntent, occurred: Time)"