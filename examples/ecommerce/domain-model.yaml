meta:
  id: ecommerce
  owner: Commerce Team

glossary:
  - id: customer
    name: Customer
    definition: "A buyer with an identity recognized by the store."
  - id: product
    name: Product
    definition: "A sellable item with catalog identity and pricing policies."
  - id: order
    name: Order
    definition: "A commitment to purchase specific products and quantities at agreed prices."
  - id: order-line
    name: OrderLine
    definition: "A specific product and quantity within an Order at a priced snapshot."
  - id: inventory-reservation
    name: InventoryReservation
    definition: "A temporary claim on stock for an Order or Shipment."
  - id: payment-intent
    name: PaymentIntent
    definition: "A customer payment authorization/capture intent for an Order."
  - id: shipment
    name: Shipment
    definition: "A fulfillment of one or more OrderLines to a delivery destination."
  - id: return
    name: Return
    definition: "A customer-initiated return of delivered merchandise."
  - id: promotion
    name: Promotion
    definition: "A policy that can reduce price under eligibility rules."

lifecycles:
  - id: order
    subject_ref: order
    states: 
      - id: draft
        name: Draft
      - id: submitted
        name: Submitted
      - id: confirmed
        name: Confirmed
      - id: partially-fulfilled
        name: PartiallyFulfilled
      - id: fulfilled
        name: Fulfilled
      - id: cancelled
        name: Cancelled
    transitions:
      - from: draft
        to: submitted
        trigger: order-submitted
      - from: submitted
        to: confirmed
        trigger: order-confirmed
      - from: confirmed
        to: partially-fulfilled
      - from: partially-fulfilled
        to: fulfilled
      - from: submitted
        to: cancelled
      - from: confirmed
        to: cancelled
    notes: "Cancellation after any fulfillment requires reverse logistics and financial adjustments."
  - id: payment-intent
    subject_ref: payment-intent
    states: 
      - id: created
        name: Created
      - id: authorized
        name: Authorized
      - id: captured
        name: Captured
      - id: voided
        name: Voided
      - id: refunded
        name: Refunded
    transitions:
      - from: created
        to: authorized
        trigger: payment-authorized
      - from: authorized
        to: captured
        trigger: payment-captured
      - from: authorized
        to: voided
      - from: captured
        to: refunded
        trigger: refund-issued
  - id: inventory-reservation
    subject_ref: inventory-reservation
    states: 
      - id: reserved
        name: Reserved
      - id: consumed
        name: Consumed
      - id: released
        name: Released
      - id: expired
        name: Expired
    transitions:
      - from: reserved
        to: consumed
      - from: reserved
        to: released
      - from: reserved
        to: expired
  - id: shipment
    subject_ref: shipment
    states: 
      - id: ready
        name: Ready
      - id: in-transit
        name: InTransit
      - id: delivered
        name: Delivered
      - id: lost
        name: Lost
    transitions:
      - from: ready
        to: in-transit
      - from: in-transit
        to: delivered
        trigger: shipment-delivered
      - from: in-transit
        to: lost
  - id: return
    subject_ref: return
    states: 
      - id: requested
        name: Requested
      - id: approved
        name: Approved
      - id: received
        name: Received
      - id: refunded
        name: Refunded
      - id: rejected
        name: Rejected
    transitions:
      - from: requested
        to: approved
      - from: approved
        to: received
      - from: received
        to: refunded
      - from: requested
        to: rejected

invariants:
  - id: price-snapshot-at-submit
    rule: "An Order's monetary commitments equal the sum of its OrderLines priced at the moment of submission, including promotions applicable at that moment."
  - id: reservation-before-confirm
    rule: "Sufficient InventoryReservation must exist for all OrderLines before an Order transitions to Confirmed."
  - id: capture-not-exceed-authorize
    rule: "Captured payment cannot exceed the last valid Authorized amount for the PaymentIntent."
  - id: ship-only-confirmed-lines
    rule: "Shipment may only include OrderLines belonging to a Confirmed (or later) Order state."
  - id: one-return-per-unit
    rule: "A delivered unit may be returned at most once."
  - id: return-window-policy
    rule: "Return can be Approved only if requested within the applicable return window for the Product."
  - id: refund-after-receipt-or-proof
    rule: "A Refund can be executed only after Returned goods are Received or acceptable proof-of-non-delivery exists."

events:
  - id: order-submitted
    name: OrderSubmitted
    definition: "OrderSubmitted(subject: Order, occurred: Time)"
    subject_ref: order
  - id: inventory-reserved
    name: InventoryReserved
    definition: "InventoryReserved(subject: InventoryReservation, occurred: Time)"
    subject_ref: inventory-reservation
  - id: order-confirmed
    name: OrderConfirmed
    definition: "OrderConfirmed(subject: Order, occurred: Time)"
    subject_ref: order
  - id: payment-authorized
    name: PaymentAuthorized
    definition: "PaymentAuthorized(subject: PaymentIntent, occurred: Time)"
    subject_ref: payment-intent
  - id: payment-captured
    name: PaymentCaptured
    definition: "PaymentCaptured(subject: PaymentIntent, occurred: Time)"
    subject_ref: payment-intent
  - id: shipment-delivered
    name: ShipmentDelivered
    definition: "ShipmentDelivered(subject: Shipment, occurred: Time)"
    subject_ref: shipment
  - id: return-requested
    name: ReturnRequested
    definition: "ReturnRequested(subject: Return, occurred: Time)"
    subject_ref: return
  - id: refund-issued
    name: RefundIssued
    definition: "RefundIssued(subject: PaymentIntent, occurred: Time)"
    subject_ref: payment-intent
